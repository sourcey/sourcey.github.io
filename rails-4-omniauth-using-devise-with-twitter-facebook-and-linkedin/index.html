<!doctype html> <html class=no-js lang=en> <head> <title>Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin | Sourcey</title> <meta charset=utf-8 /> <meta name=viewport content="width=device-width, initial-scale=1.0"/> <meta name=google-site-verification content=lC7-hHwqtiRqo7YTHc1fJ6t8ie-Hs7J4o5u3XRIF9Vw /> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/feed.xml"/> <link href="/stylesheets/app.css" media=screen rel=stylesheet /> <script src="/javascripts/all.js"></script> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-836728-7', 'sourcey.com');
      ga('send', 'pageview');
    </script> </head> <body class="article rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin_index"> <nav class=top-bar data-topbar=""> <div class=top-bar-inner> <div id=social> <a href="https://github.com/sourcey"><i class=fi-social-github></i></a> <a href="https://twitter.com/sourceydevel"><i class=fi-social-twitter></i></a> <a href="https://plus.google.com/+SourceyDevel"><i class=fi-social-google-plus></i></a> <a href="https://facebook.com/sourceydevel"><i class=fi-social-facebook></i></a> </div> <ul class=title-area> <li class=name></li> <li class="toggle-topbar menu-icon"><a href="#" class=left></a></li> </ul> <section class=top-bar-section style="left: 0%;"> <ul class=left> <li class=home><a href="/">Home</a></li> <li class=has-dropdown><a href="/#projects">Projects</a> <ul class=dropdown><li class="title back js-generated"><h5><a href="javascript:void(0)">Back</a></h5></li> <li> <a href="/libsourcey"><b>LibSourcey</b><small>C++ networking evolved</small></a> </li> <li> <a href="/anionu"><b>Anionu</b><small>Cloud video surveillance</small></a> </li> <li> <a href="http://stompstart.com"><b>StompStart</b><small>Promote your startup</small></a> </li> <li> <a href="/symple"><b>Symple</b><small>Messaging made Symple</small></a> </li> <li> <a href="/mesh"><b>Mesh</b><small>Elegant, modern design</small></a> </li> <li> <a href="/pacm"><b>Pacm</b><small>Redistributable package manager</small></a> </li> <li> <a href="/pluga"><b>Pluga</b><small>C++ plugin system</small></a> </li> <li> <a href="http://avidsense.com"><b>Avid Sense</b><small>Freedom of expression</small></a> </li> <li> <a href="/recliner"><b>Recliner.js</b><small>Flexible lazy loading</small></a> </li> </ul> </li> <li class=has-dropdown><a href="/#articles">Articles</a> <ul class=dropdown> <li><a href="/archives">Archives</a></li> <li><a href="/feed.xml">Feed</a></li> </ul> </li> <li><a href="mailto:hello@sourcey.com">Contact</a></li> <li class=divider></li> </ul> </section> </div> </nav> <header id=header> <h1 id=logo> <a title=Sourcey rel=home href="http://sourcey.com"><img height=150 width=150 title=Sourcey alt=Sourcey src="/images/logos/sourcey-glow-250x250.png"/></a> </h1> </header> <div id=main role=main> <article> <header class=article-header> <h1>Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin</h1> <div class=meta> By <a rel="author external" href="https://plus.google.com/+KamLow">Kam Low</a> &diams; <time class=updated datetime="Mar 26 2014">Mar 26 2014</time> </div> </header> <div class="article-wrap row"> <div class="large-8 columns"> <div class=content> <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <p><img alt=OmniAuth title=OmniAuth class=align-left src="/images/logos/omniauth-158x182.png"> There are quite a few OAuth solutions out there, but I want to share the one we use since it allows you to intelligently link multiple OAuth identities with a single user entity. If you use 90% of the code examples on the Internet you will wind up with a new user entity each time the user signs in with a different OAuth provider, and a bunch of very confused users.</p> <p>The OAuth provider that throws a spanner in the works and adds convolution to our code is Twitter. Unlike other providers, Twitter doesn’t share their user’s email address, so we need to add an extra step to get it from the user. More info on that <a href="#completing-the-signup-process">here</a>. </p> <p>Thanks to everyone who submitted comments and changes! For a list of code changes <a href="#changes">see here</a>.</p> <p>A quick word of warning: This isn’t a complete code example, it’s a hackers guide to using OmniAuth in Rails the right way. If you’re looking for a full fledged demo then there are plenty available on Github.</p> <h2 id=basic-implementation>Basic Implementation</h2> <p>So, without further ado, here is the code:</p> <h4 id=gemfile>Gemfile</h4> <pre class="highlight ruby"><code><span class="n">gem</span> <span class="s1">'devise'</span>
<span class="n">gem</span> <span class="s1">'omniauth'</span>
<span class="n">gem</span> <span class="s1">'omniauth-twitter'</span>
<span class="n">gem</span> <span class="s1">'omniauth-facebook'</span>
<span class="n">gem</span> <span class="s1">'omniauth-linkedin'</span>
</code></pre> <h4 id=generate-migrations-and-models>Generate migrations and models</h4> <pre class="highlight ruby"><code><span class="n">rails</span> <span class="n">generate</span> <span class="n">devise</span><span class="ss">:install</span>
<span class="n">rails</span> <span class="n">generate</span> <span class="n">devise</span> <span class="n">user</span>
<span class="n">rails</span> <span class="n">g</span> <span class="n">migration</span> <span class="n">add_name_to_users</span> <span class="nb">name</span><span class="ss">:string</span>
<span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">identity</span> <span class="n">user</span><span class="ss">:references</span> <span class="n">provider</span><span class="ss">:string</span> <span class="n">uid</span><span class="ss">:string</span>

<span class="c1"># Modify the db/migrate/[timestamp]_add_devise_to_users.rb to configure the Devise modules you will use.</span>
<span class="c1"># We usually enable the "confirmable" module when enabling email signups.</span>
</code></pre> <h4 id=appmodelsidentityrb>app/models/identity.rb</h4> <pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Identity</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">validates_presence_of</span> <span class="ss">:uid</span><span class="p">,</span> <span class="ss">:provider</span>
  <span class="n">validates_uniqueness_of</span> <span class="ss">:uid</span><span class="p">,</span> <span class="ss">:scope</span> <span class="o">=&gt;</span> <span class="ss">:provider</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_oauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
    <span class="n">find_or_create_by</span><span class="p">(</span><span class="ss">uid: </span><span class="n">auth</span><span class="p">.</span><span class="nf">uid</span><span class="p">,</span> <span class="ss">provider: </span><span class="n">auth</span><span class="p">.</span><span class="nf">provider</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <h4 id=appconfiginitializersdeviserb>app/config/initializers/devise.rb</h4> <pre class="highlight ruby"><code><span class="no">Devise</span><span class="p">.</span><span class="nf">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
<span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">config</span><span class="p">.</span><span class="nf">omniauth</span> <span class="ss">:facebook</span><span class="p">,</span> <span class="s2">"KEY"</span><span class="p">,</span> <span class="s2">"SECRET"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">omniauth</span> <span class="ss">:twitter</span><span class="p">,</span> <span class="s2">"KEY"</span><span class="p">,</span> <span class="s2">"SECRET"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">omniauth</span> <span class="ss">:linked_in</span><span class="p">,</span> <span class="s2">"KEY"</span><span class="p">,</span> <span class="s2">"SECRET"</span>
<span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre> <h4 id=configenvironmentsenvironmentrb>config/environments/[environment].rb</h4> <pre class="highlight ruby"><code><span class="p">.</span><span class="nf">.</span><span class="o">.</span>
  <span class="c1"># General Settings</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">app_domain</span> <span class="o">=</span> <span class="s1">'somedomain.com'</span>

  <span class="c1"># Email</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">perform_deliveries</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host: </span><span class="n">config</span><span class="p">.</span><span class="nf">app_domain</span> <span class="p">}</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">smtp_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">address: </span><span class="s1">'smtp.gmail.com'</span><span class="p">,</span> 
    <span class="ss">port: </span><span class="s1">'587'</span><span class="p">,</span>
    <span class="ss">enable_starttls_auto: </span><span class="kp">true</span><span class="p">,</span>
    <span class="ss">user_name: </span><span class="s1">'someuser'</span><span class="p">,</span>
    <span class="ss">password: </span><span class="s1">'somepass'</span><span class="p">,</span>
    <span class="ss">authentication: :plain</span><span class="p">,</span>
    <span class="ss">domain: </span><span class="s1">'somedomain.com'</span>
  <span class="p">}</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>
</code></pre> <h4 id=configroutesrb>config/routes.rb</h4> <pre class="highlight ruby"><code><span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">devise_for</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:controllers</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">omniauth_callbacks: </span><span class="s1">'omniauth_callbacks'</span> <span class="p">}</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>
</code></pre> <h4 id=appcontrollersomniauthcallbackscontrollerrb>app/controllers/omniauth_callbacks_controller.rb</h4> <p>It’s worth mentioning that the only safe criteria for matching user entities with OAuth providers is a verified email address, but this will lead to the creation of multiple accounts if the user has different email addresses associated with different OAuth providers. Let’s say, for example, the user registers with Facebook, and then later tries to signin with a LinkedIn account that has a different email address associated, the system can only create a new account because there’s no way to match the existing user entity with the LinkedIn account.</p> <p>Therefore, to link accounts with multiple providers the <code>current_user</code> session must be already set when the OAuth callback returns, and passed to <code>User.find_for_oauth</code>. This might sound complicated, but all thats required to link a different provider, Facebook for example, is to <code>redirect_to user_omniauth_authorize_path(:facebook)</code> while the user is already logged in.</p> <pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">OmniauthCallbacksController</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">provides_callback_for</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
    <span class="nb">class_eval</span> <span class="sx">%Q{
      def </span><span class="si">#{</span><span class="n">provider</span><span class="si">}</span><span class="sx">
        @user = User.find_for_oauth(env["omniauth.auth"], current_user)

        if @user.persisted?
          sign_in_and_redirect @user, event: :authentication
          set_flash_message(:notice, :success, kind: "</span><span class="si">#{</span><span class="n">provider</span><span class="si">}</span><span class="sx">".capitalize) if is_navigational_format?
        else
          session["devise.</span><span class="si">#{</span><span class="n">provider</span><span class="si">}</span><span class="sx">_data"] = env["omniauth.auth"]
          redirect_to new_user_registration_url
        end
      end
    }</span>
  <span class="k">end</span>

  <span class="p">[</span><span class="ss">:twitter</span><span class="p">,</span> <span class="ss">:facebook</span><span class="p">,</span> <span class="ss">:linked_in</span><span class="p">].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="o">|</span>
    <span class="n">provides_callback_for</span> <span class="n">provider</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">after_sign_in_path_for</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resource</span><span class="p">.</span><span class="nf">email_verified?</span>
      <span class="k">super</span> <span class="n">resource</span>
    <span class="k">else</span>
      <span class="n">finish_signup_path</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <h4 id=appmodelsuserrb>app/models/user.rb</h4> <pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="no">TEMP_EMAIL_PREFIX</span> <span class="o">=</span> <span class="s1">'change@me'</span>
  <span class="no">TEMP_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\Achange@me/</span>

  <span class="c1"># Include default devise modules. Others available are:</span>
  <span class="c1"># :lockable, :timeoutable</span>
  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span> <span class="ss">:confirmable</span><span class="p">,</span>
    <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span><span class="p">,</span> <span class="ss">:omniauthable</span>

  <span class="n">validates_format_of</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:without</span> <span class="o">=&gt;</span> <span class="no">TEMP_EMAIL_REGEX</span><span class="p">,</span> <span class="ss">on: :update</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_oauth</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="n">signed_in_resource</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>

    <span class="c1"># Get the identity and user if they exist</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="no">Identity</span><span class="p">.</span><span class="nf">find_for_oauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>

    <span class="c1"># If a signed_in_resource is provided it always overrides the existing user</span>
    <span class="c1"># to prevent the identity being locked with accidentally created accounts.</span>
    <span class="c1"># Note that this may leave zombie accounts (with no associated identity) which</span>
    <span class="c1"># can be cleaned up at a later date.</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">signed_in_resource</span> <span class="p">?</span> <span class="n">signed_in_resource</span> <span class="p">:</span> <span class="n">identity</span><span class="p">.</span><span class="nf">user</span>

    <span class="c1"># Create the user if needed</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">nil?</span>

      <span class="c1"># Get the existing user by email if the provider gives us a verified email.</span>
      <span class="c1"># If no verified email was provided we assign a temporary email and ask the</span>
      <span class="c1"># user to verify it on the next step via UsersController.finish_signup</span>
      <span class="n">email_is_verified</span> <span class="o">=</span> <span class="n">auth</span><span class="p">.</span><span class="nf">info</span><span class="p">.</span><span class="nf">email</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="nf">info</span><span class="p">.</span><span class="nf">verified</span> <span class="o">||</span> <span class="n">auth</span><span class="p">.</span><span class="nf">info</span><span class="p">.</span><span class="nf">verified_email</span><span class="p">)</span>
      <span class="n">email</span> <span class="o">=</span> <span class="n">auth</span><span class="p">.</span><span class="nf">info</span><span class="p">.</span><span class="nf">email</span> <span class="k">if</span> <span class="n">email_is_verified</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">email</span><span class="p">).</span><span class="nf">first</span> <span class="k">if</span> <span class="n">email</span>

      <span class="c1"># Create the user if it's a new registration</span>
      <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">nil?</span>
        <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
          <span class="ss">name: </span><span class="n">auth</span><span class="p">.</span><span class="nf">extra</span><span class="p">.</span><span class="nf">raw_info</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
          <span class="c1">#username: auth.info.nickname || auth.uid,</span>
          <span class="ss">email: </span><span class="n">email</span> <span class="p">?</span> <span class="n">email</span> <span class="p">:</span> <span class="s2">"</span><span class="si">#{</span><span class="no">TEMP_EMAIL_PREFIX</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">auth</span><span class="p">.</span><span class="nf">uid</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">auth</span><span class="p">.</span><span class="nf">provider</span><span class="si">}</span><span class="s2">.com"</span><span class="p">,</span>
          <span class="ss">password: </span><span class="no">Devise</span><span class="p">.</span><span class="nf">friendly_token</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">user</span><span class="p">.</span><span class="nf">skip_confirmation!</span>
        <span class="n">user</span><span class="p">.</span><span class="nf">save!</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># Associate the identity with the user if needed</span>
    <span class="k">if</span> <span class="n">identity</span><span class="p">.</span><span class="nf">user</span> <span class="o">!=</span> <span class="n">user</span>
      <span class="n">identity</span><span class="p">.</span><span class="nf">user</span> <span class="o">=</span> <span class="n">user</span>
      <span class="n">identity</span><span class="p">.</span><span class="nf">save!</span>
    <span class="k">end</span>
    <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">email_verified?</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">email</span> <span class="o">&amp;&amp;</span> <span class="nb">self</span><span class="p">.</span><span class="nf">email</span> <span class="o">!~</span> <span class="no">TEMP_EMAIL_REGEX</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <h2 id=completing-the-signup-process>Completing the Signup Process</h2> <p>Most OAuth providers give us all the information we need, but if the user signed up with Twitter, or perhaps for some reason the OAuth provider didn’t provide a verified email address, or maybe you just want to get some extra information from the user, then we need to implement an extra step for this.</p> <h4 id=configroutesrb-1>config/routes.rb</h4> <pre class="highlight ruby"><code><span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">match</span> <span class="s1">'/users/:id/finish_signup'</span> <span class="o">=&gt;</span> <span class="s1">'users#finish_signup'</span><span class="p">,</span> <span class="ss">via: </span><span class="p">[</span><span class="ss">:get</span><span class="p">,</span> <span class="ss">:patch</span><span class="p">],</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:finish_signup</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>
</code></pre> <h4 id=appcontrollersuserscontrollerrb>app/controllers/users_controller.rb</h4> <p>If you’re using the Devise confirmable module to verify email signups, then you may want to skip email confirmation here in order to avoid killing all the OAuth joy for the user. However, if you do want to force the user to confirm their email address then just comment out the <code>current_user.skip_reconfirmation!</code> line below. The real question is; do you trust Twitter users to provide you with a valid email address?</p> <pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_user</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>

  <span class="p">.</span><span class="nf">.</span><span class="o">.</span>

  <span class="c1"># GET /users/:id.:format</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="c1"># authorize! :read, @user</span>
  <span class="k">end</span>

  <span class="c1"># GET /users/:id/edit</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="c1"># authorize! :update, @user</span>
  <span class="k">end</span>

  <span class="c1"># PATCH/PUT /users/:id.:format</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="c1"># authorize! :update, @user</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
        <span class="n">sign_in</span><span class="p">(</span><span class="vi">@user</span> <span class="o">==</span> <span class="n">current_user</span> <span class="p">?</span> <span class="vi">@user</span> <span class="p">:</span> <span class="n">current_user</span><span class="p">,</span> <span class="ss">:bypass</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">notice: </span><span class="s1">'Your profile was successfully updated.'</span> <span class="p">}</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">head</span> <span class="ss">:no_content</span> <span class="p">}</span>
      <span class="k">else</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">action: </span><span class="s1">'edit'</span> <span class="p">}</span>
        <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">errors</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># GET/PATCH /users/:id/finish_signup</span>
  <span class="k">def</span> <span class="nf">finish_signup</span>
    <span class="c1"># authorize! :update, @user </span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">patch?</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span> <span class="c1">#&amp;&amp; params[:user][:email]</span>
      <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
        <span class="vi">@user</span><span class="p">.</span><span class="nf">skip_reconfirmation!</span>
        <span class="n">sign_in</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">:bypass</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
        <span class="n">redirect_to</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">notice: </span><span class="s1">'Your profile was successfully updated.'</span>
      <span class="k">else</span>
        <span class="vi">@show_errors</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># DELETE /users/:id.:format</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="c1"># authorize! :delete, @user</span>
    <span class="vi">@user</span><span class="p">.</span><span class="nf">destroy</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="p">}</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">head</span> <span class="ss">:no_content</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">set_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">accessible</span> <span class="o">=</span> <span class="p">[</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span> <span class="p">]</span> <span class="c1"># extend with your own params</span>
      <span class="n">accessible</span> <span class="o">&lt;&lt;</span> <span class="p">[</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="p">]</span> <span class="k">unless</span> <span class="n">params</span><span class="p">[</span><span class="ss">:user</span><span class="p">][</span><span class="ss">:password</span><span class="p">].</span><span class="nf">blank?</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="n">accessible</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre> <h4 id=appviewsusersfinishsignuphtmlerb>app/views/users/finish_signup.html.erb</h4> <p>In our implementation, the form below only collects an email address from the user, but you could easily add other required fields, and even request the user specify a password at this point so they can login with an email and password later on. Note that the following template uses Bootstrap markup.</p> <pre class="highlight html"><code><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"add-email"</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Add Email<span class="nt">&lt;/h1&gt;</span>
  <span class="err">&lt;</span>%= form_for(current_user, :as =&gt; 'user', :url =&gt; finish_signup_path(current_user), :html =&gt; { role: 'form'}) do |f| %&gt;
    <span class="err">&lt;</span>% if @show_errors <span class="err">&amp;&amp;</span> current_user.errors.any? %&gt;
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"error_explanation"</span><span class="nt">&gt;</span>
        <span class="err">&lt;</span>% current_user.errors.full_messages.each do |msg| %&gt;
          <span class="err">&lt;</span>%= msg %&gt;<span class="nt">&lt;br&gt;</span>
        <span class="err">&lt;</span>% end %&gt;
      <span class="nt">&lt;/div&gt;</span>
    <span class="err">&lt;</span>% end %&gt;
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="err">&lt;</span>%= f.label :email %&gt;
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"controls"</span><span class="nt">&gt;</span>
        <span class="err">&lt;</span>%= f.text_field :email, :autofocus =&gt; true, :value =&gt; '', class: 'form-control input-lg', placeholder: 'Example: email@me.com' %&gt;
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"help-block"</span><span class="nt">&gt;</span>Please confirm your email address. No spam.<span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
      <span class="err">&lt;</span>%= f.submit 'Continue', :class =&gt; 'btn btn-primary' %&gt;
    <span class="nt">&lt;/div&gt;</span>
  <span class="err">&lt;</span>% end %&gt;
<span class="nt">&lt;/div&gt;</span>
</code></pre> <h4 id=appcontrollersapplicationcontrollerrb>app/controllers/application_controller.rb</h4> <p>The following method is optional, but it’s useful if you want to ensure the user has provided all the necessary information before accessing a specific resource.</p> <p>You can use it in a <code>before_filter</code> like so: <code>before_filter :ensure_signup_complete, only: [:new, :create, :update, :destroy]</code></p> <pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>

  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>

  <span class="nf">def</span> <span class="n">ensure_signup_complete</span>
    <span class="c1"># Ensure we don't go into an infinite loop</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">'finish_signup'</span>

    <span class="c1"># Redirect to the 'finish_signup' page if the user</span>
    <span class="c1"># email hasn't been verified yet</span>
    <span class="k">if</span> <span class="n">current_user</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_user</span><span class="p">.</span><span class="nf">email_verified?</span>
      <span class="n">redirect_to</span> <span class="n">finish_signup_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <p>Well that’s pretty much it! If I left anything out please give me a shout and I’ll update the article, cheers!</p> <h2 id=changes>Changes</h2> <ul> <li>Added <code>UsersController.set_user</code> method for clarity</li> <li>Removed duplicate controller methods from <code>OmniauthCallbacksController</code> </li> <li>Only accept verified email addresses from the provider via ‘User.find_for_oauth’</li> <li>Removed redundant <code>gem "omniauth"</code> from <code>Gemfile</code> </li> <li>Updated <code>User.find_for_oauth</code> to better handle <code>signed_in_resource</code>. Thanks <a href="https://github.com/mtuckerb">@mtuckerb</a> </li> <li>Renamed <code>UsersController.add_email</code> to <code>UsersController.finish_signup</code> </li> <li>Renamed <code>ApplicationController.ensure_valid_email</code> to <code>ApplicationController.ensure_signup_complete</code> </li> <li>Override <code>OmniauthCallbacksController.after_sign_in_path_for</code> to redirect to <code>UsersController.finish_signup</code> instead of forcing via <code>before_filter</code> </li> <li>Added <code>UsersController.user_params</code> to filter <code>:password</code> and <code>:password_confirmation</code> when blank</li> <li>Temporary email addresses are now unique</li> <li> <code>signed_in_resource</code> always overrides existing user entity in <code>User.find_for_oauth</code> </li> <li>Simplified <code>Identity.find_for_oauth</code> method. Thanks Ahmed Mostafa</li> <li>Posted a more complete <code>UsersController</code>.</li> </ul> </body></html> </div> </div> <div class="large-4 columns"> <div class=sidebar> <div class="sidebar-section toc"> <h4 class=no_toc id=contents>Contents</h4> <ul id=markdown-toc> <li> <a id=markdown-toc-basic-implementation href="#basic-implementation">Basic Implementation</a> <ul> <li><a id=markdown-toc-gemfile href="#gemfile">Gemfile</a></li> <li><a id=markdown-toc-generate-migrations-and-models href="#generate-migrations-and-models">Generate migrations and models</a></li> <li><a id=markdown-toc-appmodelsidentityrb href="#appmodelsidentityrb">app/models/identity.rb</a></li> <li><a id=markdown-toc-appconfiginitializersdeviserb href="#appconfiginitializersdeviserb">app/config/initializers/devise.rb</a></li> <li><a id=markdown-toc-configenvironmentsenvironmentrb href="#configenvironmentsenvironmentrb">config/environments/[environment].rb</a></li> <li><a id=markdown-toc-configroutesrb href="#configroutesrb">config/routes.rb</a></li> <li><a id=markdown-toc-appcontrollersomniauthcallbackscontrollerrb href="#appcontrollersomniauthcallbackscontrollerrb">app/controllers/omniauth_callbacks_controller.rb</a></li> <li><a id=markdown-toc-appmodelsuserrb href="#appmodelsuserrb">app/models/user.rb</a></li> </ul> </li> <li> <a id=markdown-toc-completing-the-signup-process href="#completing-the-signup-process">Completing the Signup Process</a> <ul> <li><a id=markdown-toc-configroutesrb-1 href="#configroutesrb-1">config/routes.rb</a></li> <li><a id=markdown-toc-appcontrollersuserscontrollerrb href="#appcontrollersuserscontrollerrb">app/controllers/users_controller.rb</a></li> <li><a id=markdown-toc-appviewsusersfinishsignuphtmlerb href="#appviewsusersfinishsignuphtmlerb">app/views/users/finish_signup.html.erb</a></li> <li><a id=markdown-toc-appcontrollersapplicationcontrollerrb href="#appcontrollersapplicationcontrollerrb">app/controllers/application_controller.rb</a></li> </ul> </li> <li><a id=markdown-toc-changes href="#changes">Changes</a></li> </ul> </div> <div class="sidebar-section tags"> <h4>Tags</h4> <ul><li><a href="/tags/oauth/">OAuth</a></li><li><a href="/tags/programming/">Programming</a></li><li><a href="/tags/ruby/">Ruby</a></li><li><a href="/tags/rails/">Rails</a></li></ul> </div> <div class="sidebar-section ad ad-300x250 sidebar-float"> <ins class=adsbygoogle style="display:inline-block;width:300px;height:600px" data-ad-client=ca-pub-1397369873900370 data-ad-slot=7510590887></ins> <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script> </div> </div> </div> </article> <div class=row> <div class=social-buttons> <ul> <li> <a href="http://twitter.com/share" class="socialite twitter-share" data-text="Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin" data-url="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" data-count=vertical rel=nofollow target=_blank><span class=vhidden>Share on Twitter</span></a> </li> <li> <a href="https://plus.google.com/share?url=http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" class="socialite googleplus-one" data-size=tall data-href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" rel=nofollow target=_blank><span class=vhidden>Share on Google+</span></a> </li> <li> <a href="http://www.facebook.com/sharer.php?u=http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/&amp;t=Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin" class="socialite facebook-like" data-href="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" data-send=false data-layout=box_count data-width=60 data-show-faces=false rel=nofollow target=_blank><span class=vhidden>Share on Facebook</span></a> </li> <li> <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/&amp;title=Rails 4 OmniAuth using Devise with Twitter, Facebook and Linkedin" class="socialite linkedin-share" data-url="http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/" data-counter=top rel=nofollow target=_blank><span class=vhidden>Share on LinkedIn</span></a> </li> </ul> </div> </div> <div id=disqus_thread></div> <script>
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'sourcey'; // required: replace example with your forum shortname

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" rel=nofollow>comments powered by Disqus.</a></noscript> <a href="http://disqus.com" rel=nofollow class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a> </div> <footer id=footer> <div class="row show-for-large-up"> <div class="ad ad-720x90 text-center"> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class=adsbygoogle style="display:inline-block;width:728px;height:90px" data-ad-client=ca-pub-1397369873900370 data-ad-slot=8042301285></ins> <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
          </script> </div> </div> <p> As with all business minded artists, we have fought the inevitable battle of conformity vs expression, and have emerged victorious with sanity intact to plunder the digiverse in search of new and interesting challenges. For more information, or a quote, drop us an email and tell us what you're working on. </p> <p>&copy; 2016 Sourcey<p> </footer> </body> </html>